<html>
<head>
  <title>Redis 深度历险：核心原理与应用实践 - 老錢 - 掘金小册</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307474 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="4326"/>
<h1>Redis 深度历险：核心原理与应用实践 - 老錢 - 掘金小册</h1>

<div>
<span><div style="text-size-adjust: 100%; font-size: 12px; word-break: break-word; text-rendering: optimizeLegibility; background-color: rgb(244, 245, 245);"><div style="overflow:hidden;"><div style="transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"><div style="box-sizing:border-box;background-color:rgb(230, 231, 233);"><div style="box-shadow:rgba(0, 0, 0, 0.15) 1px 1px 8px;background-color:rgb(255, 255, 255);border-radius:2px;box-sizing:border-box;"><div style="word-break: break-word; font-size: 15px;"><h1 style="font-size: 30px; margin: 35px 0px 5px; padding-bottom: 5px;"><span style="font-size: 16px; display: inline-block; min-width: 100%; position: relative;"><span style="font-size: 30px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.5;">拓展 5：优胜劣汰 —— LRU</span></span></h1><div style="margin-bottom: 22px; margin-top: 25px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">当 Redis 内存超出物理内存限制时，内存的数据会开始和磁盘产生频繁的交换 (swap)。交换会让 Redis 的性能急剧下降，对于访问量比较频繁的 Redis 来说，这样龟速的存取效率基本上等于不可用。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">在生产环境中我们是不允许 Redis 出现交换行为的，为了限制最大使用内存，Redis 提供了配置参数</span> <span style="color: rgb(255, 80, 44); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75; background-color: rgb(255, 245, 245); border-radius: 2px; overflow-x: auto; padding: 0.065em 0.4em; word-break: break-word;">maxmemory</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">来限制内存超出期望大小。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">当实际内存超出</span> <span style="color: rgb(255, 80, 44); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75; background-color: rgb(255, 245, 245); border-radius: 2px; overflow-x: auto; padding: 0.065em 0.4em; word-break: break-word;">maxmemory</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">时，Redis 提供了几种可选策略 (maxmemory-policy) 来让用户自己决定该如何腾出新的空间以继续提供读写服务。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">noeviction</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">不会继续服务写请求 (DEL 请求可以继续服务)，读请求可以继续进行。这样可以保证不会丢失数据，但是会让线上的业务不能持续进行。这是默认的淘汰策略。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">volatile-lru</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">尝试淘汰设置了过期时间的 key，最少使用的 key 优先被淘汰。没有设置过期时间的 key 不会被淘汰，这样可以保证需要持久化的数据不会突然丢失。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">volatile-ttl</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">跟上面一样，除了淘汰的策略不是 LRU，而是 key 的剩余寿命 ttl 的值，ttl 越小越优先被淘汰。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">volatile-random</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">跟上面一样，不过淘汰的 key 是过期 key 集合中随机的 key。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">allkeys-lru</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">区别于 volatile-lru，这个策略要淘汰的 key 对象是全体的 key 集合，而不只是过期的 key 集合。这意味着没有设置过期时间的 key 也会被淘汰。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 700; line-height: 1.75;">allkeys-random</span> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">跟上面一样，不过淘汰的策略是随机的 key。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">volatile-xxx 策略只会针对带过期时间的 key 进行淘汰，allkeys-xxx 策略会对所有的 key 进行淘汰。如果你只是拿 Redis 做缓存，那应该使用 allkeys-xxx，客户端写缓存时不必携带过期时间。如果你还想同时使用 Redis 的持久化功能，那就使用 volatile-xxx 策略，这样可以保留没有设置过期时间的 key，它们是永久的 key 不会被 LRU 算法淘汰。</span></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.5;">LRU 算法</span></h2><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">实现 LRU 算法除了需要 key/value 字典外，还需要附加一个链表，链表中的元素按照一定的顺序进行排列。当空间满的时候，会踢掉链表尾部的元素。当字典的某个元素被访问时，它在链表中的位置会被移动到表头。所以链表的元素排列顺序就是元素最近被访问的时间顺序。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">位于链表尾部的元素就是不被重用的元素，所以会被踢掉。位于表头的元素就是最近刚刚被人用过的元素，所以暂时不会被踢。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">下面我们使用 Python 的 OrderedDict(双向链表 + 字典) 来实现一个简单的 LRU 算法。</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="py" style="border-radius: 2px; word-break: normal; font-size: 11px; overflow-x: auto; margin: 0px; background: rgb(248, 248, 248); padding: 18px 15px 12px;"><div><span style="font-size: 11px; position: absolute; right: 15px; top: 2px; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">py</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">from</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">collections</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">import</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">OrderedDict</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">class</span> <span style="font-size: 11px; color: rgb(68, 85, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">LRUDict</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">(OrderedDict):</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">def</span> <span style="font-size: 11px; color: rgb(153, 0, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">__init__</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">(self, capacity):</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.capacity = capacity</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items = OrderedDict()</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">def</span> <span style="font-size: 11px; color: rgb(153, 0, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">__setitem__</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">(self, key, value):</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">old_value = self.items.get(key)</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">if</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">old_value</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">is</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">not</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">None</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">:</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items.pop(key)</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items[key] = value</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">elif</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">len(self.items) &lt; self.capacity:</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items[key] = value</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">else</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">:</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items.popitem(last=</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">True</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">)</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items[key] = value</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">def</span> <span style="font-size: 11px; color: rgb(153, 0, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">__getitem__</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">(self, key):</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">value = self.items.get(key)</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">if</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">value</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">is</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">not</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">None</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">:</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items.pop(key)</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">self.items[key] = value</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">return</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">value</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">def</span> <span style="font-size: 11px; color: rgb(153, 0, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">__repr__</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">(self):</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">return</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">repr(self.items)</span></div><div><br/></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">d = LRUDict(</span><span style="font-size: 11px; color: teal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">10</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">)</span></div><div><br/></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">for</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">i</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">in</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">range(</span><span style="font-size: 11px; color: teal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">15</span><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">):</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">d[i] = i</span></div><div><span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 700; line-height: 1.75;">print</span> <span style="font-size: 11px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-weight: 400; line-height: 1.75;">d</span></div></div></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.5;">近似 LRU 算法</span></h2><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">Redis 使用的是一种近似 LRU 算法，它跟 LRU 算法还不太一样。之所以不使用 LRU 算法，是因为需要消耗大量的额外的内存，需要对现有的数据结构进行较大的改造。近似 LRU 算法则很简单，在现有数据结构的基础上使用随机采样法来淘汰元素，能达到和 LRU 算法非常近似的效果。Redis 为实现近似 LRU 算法，它给每个 key 增加了一个额外的小字段，这个字段的长度是 24 个 bit，也就是最后一次被访问的时间戳。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">上一节提到处理 key 过期方式分为集中处理和懒惰处理，LRU 淘汰不一样，它的处理方式只有懒惰处理。当 Redis 执行写操作时，发现内存超出 maxmemory，就会执行一次 LRU 淘汰算法。这个算法也很简单，就是随机采样出 5(可以配置) 个 key，然后淘汰掉最旧的 key，如果淘汰后内存还是超出 maxmemory，那就继续随机采样淘汰，直到内存低于 maxmemory 为止。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">如何采样就是看 maxmemory-policy 的配置，如果是 allkeys 就是从所有的 key 字典中随机，如果是 volatile 就从带过期时间的 key 字典中随机。每次采样多少个 key 看的是 maxmemory_samples 的配置，默认为 5。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">下面是随机 LRU 算法和严格 LRU 算法的效果对比图：</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><img src="https://user-gold-cdn.xitu.io/2018/7/17/164a60daf989f5e2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" style="font-size: 11pt; color: rgb(51, 51, 51);" width="737"></img></div><div style="text-align: center; font-size: 12px; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">图中绿色部分是新加入的 key，深灰色部分是老旧的 key，浅灰色部分是通过 LRU 算法淘汰掉的 key。从图中可以看出采样数量越大，近似 LRU 算法的效果越接近严格 LRU 算法。同时 Redis3.0 在算法中增加了淘汰池，进一步提升了近似 LRU 算法的效果。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">淘汰池是一个数组，它的大小是 maxmemory_samples，在每一次淘汰循环中，新随机出来的 key 列表会和淘汰池中的 key 列表进行融合，淘汰掉最旧的一个 key 之后，保留剩余较旧的 key 列表放入淘汰池中留待下一个循环。</span></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.5;">扩展阅读</span></h2><ul style="padding:0px;margin:0px;padding-left:28px;"><li style="margin-bottom:0px;list-style:inherit;"><div><a href="https://link.juejin.im/?target=https%3A%2F%2Fyq.aliyun.com%2Farticles%2F63034" rel="nofollow noopener noreferrer" style="background-color: transparent; cursor: pointer; border-bottom: 1px solid rgb(209, 233, 255); font-size: 15px; font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75; color: rgb(2, 105, 200); text-decoration: none;" target="_blank">《Redis 作为 LRU Cache 的实现》</a></div></li><li style="margin-bottom:0px;list-style:inherit;"><div><a href="https://link.juejin.im/?target=https%3A%2F%2Fblog.csdn.net%2Fmysqldba23%2Farticle%2Fdetails%2F68482894" rel="nofollow noopener noreferrer" style="background-color: transparent; cursor: pointer; border-bottom: 1px solid rgb(209, 233, 255); font-size: 15px; font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75; color: rgb(2, 105, 200); text-decoration: none;" target="_blank">《Redis LRU 实现策略》</a></div></li></ul><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.5;">思考 &amp; 作业</span></h2><ol style="padding-left:28px;"><li style="margin-bottom:0px;list-style:inherit;padding-left:6px;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">如果你是 Java 用户，试一试用 LinkedHashMap 实现一个 LRU 字典。</span></div></li><li style="margin-bottom:0px;list-style:inherit;padding-left:6px;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">如果你是 Golang 用户，阅读一下</span> <a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fhashicorp%2Fgolang-lru" rel="nofollow noopener noreferrer" style="background-color: transparent; cursor: pointer; border-bottom: 1px solid rgb(209, 233, 255); font-size: 15px; font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75; color: rgb(2, 105, 200); text-decoration: none;" target="_blank">golang-lru</a> <span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif; font-weight: 400; line-height: 1.75;">的源码。</span></div></li></ol></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 